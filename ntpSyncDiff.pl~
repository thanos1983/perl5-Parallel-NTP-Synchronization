#!/usr/bin/perl
use FiLeS;
use strict;
use warnings;
use Net::NTP;
use parallelSsh;
use Data::Dumper;
use processLogFiles;
use Fcntl qw( :flock );
use Net::OpenSSH::Parallel;
use Time::HiRes qw(gettimeofday tv_interval);

use constant {
    sudoFalse => 0,
    sudoTrue  => 1,
};

my %WARNS = ();
my @stdout_fh = ();
my @stderr_fh = ();
my @log_files = ();

my $confFile = "conf.ini";
my $logConf  = "log4perl.ini";
my $dirFile  = "directories.ini";

my %grepLinuxOS = (
    commandIndexHash => [ 0 ] ,
    constant         => [ sudoFalse ] ,
    LinuxOSIPs       => { allLinuxOSIPs => "*" },
    commands         => [ "ntpq -np; echo %HOST%" ] );

my $objectFiles      = FiLeS->new( $dirFile ,
				   $confFile ,
				   $logConf );

my $refHashConf      = $objectFiles->getConfFile();
my $refHashDir       = $objectFiles->getDirFile();
my $refLog4PerlConf  = $objectFiles->getlogPerlConfFile();

my $refHashDirectories  = $objectFiles->makeDirectories( $refHashDir );
my $refHashConfMakeFile = $objectFiles->makeLog4PerlLogFile( $refLog4PerlConf );

my $objectParallelSsh = parallelSsh->new( "hashConfRef" ,
					  "refHashDir" ,
					  "refHashLog" , 
					  "refHashGrepLinuxOSIPs" );

my $t0 = [gettimeofday];
my ( $dataLogFiles ) = $objectParallelSsh->getOsDistribution( $refHashDirectories ,
							      $refHashConf ,
							      $refLog4PerlConf ,
							      \%grepLinuxOS );
my $t1 = [gettimeofday];
my %response = get_ntp_response("0.se.pool.ntp.org",123);

print "This is what we want: " . $response{'Reference Timestamp'} . "\n";

my $elapsed = tv_interval ($t0, $t1);

print "Elapsed time: ".$elapsed."\n";

=important
    We need to add the process time of ssh::parallel
    elapsed time + offset = time difference from ref server time
=cut

my $objectProcessLogFiles = processLogFiles->new( "refLogFile" , "refPrintOutput" );

# Get the NTP offset from several NTP servers
my $refHashProcessData = $objectProcessLogFiles->processDataLogFile( $dataLogFiles );

my $refHashProcessOffsetNTP = $objectProcessLogFiles->processOffsetNTP( $refHashProcessData );

print Dumper $refHashProcessOffsetNTP;

__END__

Sample of output:

This is what we want: 1432509068.31904
Elapsed time: 0.740087
$VAR1 = {
          '10.0.0.17' => ' offset  0.000  0.000  0.000  8.028  6.9501',
          '10.0.0.6' => ' offset-16.533-15.602-16.799-16.703-17.225'
        };

